/*
 * Quiz API
 *
 * This is a simple server for managing quiz questions
 *
 * OpenAPI spec version: 1.0.0
 * 
 * Generated by: https://github.com/swagger-api/swagger-codegen.git
 */
using com.awawawiwa.DTOs;
using com.awawawiwa.Services;
using IO.Swagger.Attributes;
using IO.Swagger.Security;
using log4net.Core;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Swashbuckle.AspNetCore.Annotations;
using System;
using System.IO;
using System.Threading.Tasks;

namespace IO.Swagger.Controllers
{
    /// <summary>
    /// 
    /// </summary>
    [ApiController]
    [Route("v1/users")]
    public class UserController : ControllerBase
    {
        private readonly IUserService _userService;
        private readonly ILogger<UserController> _logger;

        /// <summary>
        /// constructor
        /// </summary>
        /// <param name="userService"></param>
        /// <param name="logger"></param>
        public UserController(IUserService userService, ILogger<UserController> logger)
        {
            _userService = userService;
            _logger = logger;
        }

        /// <summary>
        /// Login a user
        /// </summary>
        /// <param name="userInputDTO"></param>
        /// <response code="200">Login successful</response>
        /// <response code="401">Invalid username or password</response>
        [HttpPost("login")]
        [ValidateModelState]
        [SwaggerOperation("LoginUser")]
        [SwaggerResponse(200, "Login successful")]
        [SwaggerResponse(401, "Invalid username or password")]
        public virtual async Task<IActionResult> LoginUserAsync([FromBody] LoginUserInputDTO userInputDTO)
        {
            _logger.LogInformation(">>> Call LoginUser");

            var loginUserOutputDTO = await _userService.LoginUserAsync(userInputDTO);

            _logger.LogInformation("<<< LoginUser completed");

            if (string.IsNullOrEmpty(loginUserOutputDTO?.Token))
            {
                return Unauthorized(new { message = "Invalid username or password" });
            }

            return Ok(loginUserOutputDTO);
        }

        /// <summary>
        /// Create a new user
        /// </summary>
        /// <param name="body"></param>
        /// <response code="201">Successfully created new user</response>
        /// <response code="500">Internal Server Error</response>
        /// <response code="409">Db Conflict</response>
        [HttpPost]
        [ValidateModelState]
        [SwaggerOperation("CreateUser")]
        [SwaggerResponse(statusCode: 201, description: "Successfully created new user")]
        [SwaggerResponse(statusCode: 500, description: "Internal Server Error")]
        [SwaggerResponse(statusCode: 409, description: "Db Conflict")]
        public virtual async Task<IActionResult> CreateUserAsync([FromBody] CreateUserInputDTO body)
        {
            _logger.LogInformation(">>> Call CreateUser");

            var result = await _userService.CreateUserAsync(body);

            _logger.LogInformation("<<< CreateUser completed");

            if (!result.Success)
            {
                return Conflict(new { message = result.ErrorMessage });
            }

            return Ok();
        }

        /// <summary>
        /// Delete User
        /// </summary>
        /// <param name="userId"></param>
        /// <response code="200">Successfully deleted user</response>
        /// <response code="500">Internal Server Error</response>
        /// <response code="404">User not found</response>
        [HttpDelete("{userId}")]
        [ValidateModelState]
        [Authorize(AuthenticationSchemes = BearerAuthenticationHandler.SchemeName)]
        [SwaggerOperation("DeleteUser")]
        [SwaggerResponse(statusCode: 200, description: "Successfully deleted user")]
        [SwaggerResponse(statusCode: 403, description: "Forbidden - can't delete other users")]
        [SwaggerResponse(statusCode: 500, description: "Internal Server Error")]
        [SwaggerResponse(statusCode: 404, description: "User not found")]
        public virtual async Task<IActionResult> DeleteUserAsync(Guid userId)
        {
            _logger.LogInformation(">>> Call DeleteUser");

            var loggedInUser = User.FindFirst("userId")?.Value;

            if (string.IsNullOrEmpty(loggedInUser) || loggedInUser != userId.ToString())
            {
                return Forbid();
            }

            var token = Request.Headers["Authorization"].ToString().Replace("Bearer ", "");

            var result = await _userService.DeleteUserAsync(userId);

            _logger.LogInformation("<<< DeleteUser completed");

            if (!result.Success)
            {
                return NotFound(new { message = result.ErrorMessage });
            }

            _userService.LogoutUser(token);
            return Ok();
        }

        /// <summary>
        /// Logout user
        /// </summary>
        /// <response code="201">Successfully deleted user</response>
        /// <response code="500">Internal Server Error</response>
        /// <response code="404">User not found</response>
        [HttpPost("logout")]
        [ValidateModelState]
        [Authorize(AuthenticationSchemes = BearerAuthenticationHandler.SchemeName)]
        [SwaggerOperation("LogoutUser")]
        [SwaggerResponse(statusCode: 201, description: "Successfully logged out user")]
        [SwaggerResponse(statusCode: 403, description: "Forbidden - can't logout other users")]
        [SwaggerResponse(statusCode: 500, description: "Internal Server Error")]
        [SwaggerResponse(statusCode: 404, description: "User not found")]
        public virtual IActionResult LogoutUserAsync()
        {
            _logger.LogInformation(">>> Call LogoutUser");

            var token = Request.Headers["Authorization"].ToString().Replace("Bearer ", "");

            _logger.LogInformation("<<< LogoutUser completed");

            if (string.IsNullOrEmpty(token))
            {
                return BadRequest("No token found");
            }

            _userService.LogoutUser(token);
            return Ok();
        }

        /// <summary>
        /// Get user data
        /// </summary>
        /// <response code="201">Successfully deleted user</response>
        /// <response code="500">Internal Server Error</response>
        /// <response code="404">User not found</response>
        [HttpGet("me")]
        [ValidateModelState]
        [Authorize(AuthenticationSchemes = BearerAuthenticationHandler.SchemeName)]
        [SwaggerOperation("LogoutUser")]
        [SwaggerResponse(statusCode: 201, description: "Successfully got user data")]
        [SwaggerResponse(statusCode: 403, description: "Forbidden - can't access other users' data")]
        [SwaggerResponse(statusCode: 500, description: "Internal Server Error")]
        [SwaggerResponse(statusCode: 404, description: "User not found")]
        public virtual async Task<IActionResult> GetUserDataAsync()
        {
            _logger.LogInformation(">>> Call GetUserData");

            var userId = User.FindFirst("userId")?.Value;

            var userData = await _userService.GetUserDataAsync(Guid.Parse(userId));

            _logger.LogInformation("<<< GetUserData completed");
            return Ok(userData);
        }

        /// <summary>
        /// Upload profile picture for the logged-in user
        /// </summary>
        /// <response code="201">Successfully deleted user</response>
        /// <response code="500">Internal Server Error</response>
        /// <response code="404">User not found</response>
        [HttpPost("me/profilePicture")]
        [ValidateModelState]
        [Authorize(AuthenticationSchemes = BearerAuthenticationHandler.SchemeName)]
        [SwaggerOperation("UploadProfilePicture")]
        [SwaggerResponse(statusCode: 201, description: "Successfully logged out user")]
        [SwaggerResponse(statusCode: 403, description: "Forbidden - can't logout other users")]
        [SwaggerResponse(statusCode: 500, description: "Internal Server Error")]
        [SwaggerResponse(statusCode: 404, description: "User not found")]
        public virtual async Task<IActionResult> UploadProfilePicture([FromForm] IFormFile profilePicture)
        {
            _logger.LogInformation(">>> Call UploadProfilePicture");

            var userId = User.FindFirst("userId")?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                return BadRequest("No user ID found");
            }

            var result = await _userService.UploadProfilePictureAsync(Guid.Parse(userId), profilePicture);

            _logger.LogInformation("<<< UploadProfilePicture completed");

            if (!result.Success)
            {
                return BadRequest(result);
            }

            return Ok(result);
        }
    }
}
